name: Continuous Deployment

on:
  workflow_run:
    workflows: ["Continuous Integration"]
    types: [completed]

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  dev-image:
    name: Retag and Push Dev Image
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' && !startsWith(github.event.workflow_run.head_sha, 'refs/tags/v') }}
    steps:
      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull, retag, and push dev image
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:ci-${{ github.event.workflow_run.head_sha }}
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:ci-${{ github.event.workflow_run.head_sha }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:dev
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:dev
  detect-tag:
    name: Detect v* Tag
    runs-on: ubuntu-latest
    outputs:
      vtag: ${{ steps.find_tag.outputs.vtag }}
    steps:
      - uses: actions/checkout@v5
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0
          fetch-tags: true

      - name: Find v* Tag
        id: find_tag
        run: |
          echo "[Detect v* Tag] HEAD SHA: ${{ github.event.workflow_run.head_sha }}"
          echo "[Detect v* Tag] All tags pointing at HEAD:"
          git tag --points-at ${{ github.event.workflow_run.head_sha }}
          TAG=$(git tag --points-at ${{ github.event.workflow_run.head_sha }} | grep -E '^v[0-9]' | head -n1 || true)
          if [ -n "$TAG" ]; then
            echo "[Detect v* Tag] Found v* tag: $TAG"
          else
            echo "[Detect v* Tag] No v* tag found."
          fi
          echo "vtag=$TAG" >> $GITHUB_OUTPUT

  prod-image:
    name: Retag and Push Prod Image
    runs-on: ubuntu-latest
    needs: detect-tag
    if: ${{ github.event.workflow_run.conclusion == 'success' && needs.detect-tag.outputs.vtag != '' }}
    steps:
      - uses: docker/setup-buildx-action@v3

      - uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull, retag, and push prod image
        run: |
          TAG=${{ needs.detect-tag.outputs.vtag }}
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:ci-${{ github.event.workflow_run.head_sha }}
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:ci-${{ github.event.workflow_run.head_sha }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$TAG
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:$TAG
          # Add these lines for latest
          docker tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:ci-${{ github.event.workflow_run.head_sha }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
