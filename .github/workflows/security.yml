name: Security Scanning

on:
  # Trigger after successful CD deployment
  workflow_run:
    workflows: ["Continuous Deployment"]
    types: [completed]
    branches: [main]

  # Allow manual trigger for security audits
  workflow_dispatch:
    inputs:
      image_tag:
        description: "Docker image tag to scan (defaults to latest)"
        required: false
        default: "latest"
        type: string

  # Monthly security audit
  schedule:
    - cron: "0 2 1 * *" # First day of every month at 2 AM UTC

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Only run if CD workflow succeeded
  check-cd-status:
    name: Check CD Status
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_run'
    outputs:
      cd-passed: ${{ steps.check.outputs.result }}
      should-scan: ${{ steps.check.outputs.should-scan }}
    steps:
      - name: Check CD workflow result
        id: check
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
            echo "result=true" >> $GITHUB_OUTPUT
            echo "should-scan=true" >> $GITHUB_OUTPUT
          else
            echo "result=false" >> $GITHUB_OUTPUT
            echo "should-scan=false" >> $GITHUB_OUTPUT
          fi

  python-security-scan:
    name: Python Code Security
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_run' && needs.check-cd-status.outputs.should-scan == 'true')
    needs: [check-cd-status]
    continue-on-error: false
    permissions:
      security-events: write
      contents: read
      actions: read

    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      # CodeQL static analysis with false positive filtering
      - uses: github/codeql-action/init@v4
        with:
          languages: python
          config-file: ./.github/codeql/codeql-config.yml
          queries: security-and-quality

      # Manual build step for CodeQL (prevents autobuild conflicts)
      - uses: github/codeql-action/autobuild@v4

      - uses: github/codeql-action/analyze@v4
        with:
          category: "/language:python"
          upload: false
          output: "codeql-results"
        continue-on-error: true

      - name: Cache pip dependencies
        uses: actions/cache@v5
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-security-3.13-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-pip-security-3.13-
            ${{ runner.os }}-pip-security-
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .[dev]

      - run: make security-bandit PYTHON=python
        continue-on-error: true

      - run: make security-pip-audit PYTHON=python
        continue-on-error: true

      - name: Filter CodeQL results
        if: always()
        run: |
          echo "Debugging: Current directory contents:"
          ls -la

          echo "Debugging: Looking for SARIF files..."
          find . -name "*.sarif" -type f 2>/dev/null || echo "No SARIF files found in current directory"

          # CodeQL analyze action with output specified saves SARIF to the specified directory
          sarif_file=""

          # Look for SARIF files in the output directory and current directory
          for search_path in "codeql-results" "."; do
            if [ -d "$search_path" ]; then
              echo "Searching in directory: $search_path"
              found_sarif=$(find "$search_path" -name "*.sarif" -type f 2>/dev/null | head -1)
              if [ -n "$found_sarif" ] && [ -f "$found_sarif" ]; then
                sarif_file="$found_sarif"
                echo "Found SARIF file at: $sarif_file"
                break
              fi
            fi
          done

          if [ -n "$sarif_file" ] && [ -f "$sarif_file" ]; then
            echo "Processing SARIF file: $sarif_file"
            echo "SARIF file size: $(wc -c < "$sarif_file") bytes"
            python .github/scripts/filter_sarif.py "$sarif_file" "codeql-filtered.sarif"
            echo "CodeQL SARIF filtering completed"
          else
            echo "No CodeQL SARIF file found - creating minimal valid SARIF"
            cat > codeql-filtered.sarif << 'EOF'
          {
            "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
            "version": "2.1.0",
            "runs": [
              {
                "tool": {
                  "driver": {
                    "name": "CodeQL",
                    "version": "0.0.0"
                  }
                },
                "results": []
              }
            ]
          }
          EOF
          fi

          echo "Final SARIF file size: $(wc -c < codeql-filtered.sarif) bytes"

      - name: Upload filtered CodeQL results
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: codeql-filtered.sarif
          category: "/language:python"
        continue-on-error: true

      - uses: actions/upload-artifact@v6
        if: always()
        with:
          name: python-security-reports-${{ github.run_id }}
          path: |
            bandit-report.json
            pip-audit-report.json
            codeql-filtered.sarif
          retention-days: 30

  docker-security-scan-dev:
    name: Docker Image Security (dev)
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.image_tag == 'dev') ||
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_run' && needs.check-cd-status.outputs.should-scan == 'true' && github.event.workflow_run.head_branch == 'main')
    needs: [check-cd-status]
    continue-on-error: false

    permissions:
      security-events: write
      contents: read
      actions: read

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check if dev image exists
        id: image-check
        run: |
          if docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:dev > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Image dev exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Image dev does not exist, skipping scan"
          fi

      - name: Run Trivy vulnerability scanner
        if: steps.image-check.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:dev
          format: "sarif"
          output: "trivy-results-dev.sarif"

      - name: Upload Trivy scan results to GitHub Security tab
        if: steps.image-check.outputs.exists == 'true'
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        with:
          sarif_file: "trivy-results-dev.sarif"
          category: "docker-dev"

  docker-security-scan-latest:
    name: Docker Image Security (latest)
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.image_tag == 'latest' || github.event.inputs.image_tag == '')) ||
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_run' && needs.check-cd-status.outputs.should-scan == 'true' && startsWith(github.event.workflow_run.head_branch, 'v'))
    needs: [check-cd-status]
    continue-on-error: false

    permissions:
      security-events: write
      contents: read
      actions: read

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check if latest image exists
        id: image-check
        run: |
          if docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Image latest exists"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Image latest does not exist, skipping scan"
          fi

      - name: Run Trivy vulnerability scanner
        if: steps.image-check.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          format: "sarif"
          output: "trivy-results-latest.sarif"

      - name: Upload Trivy scan results to GitHub Security tab
        if: steps.image-check.outputs.exists == 'true'
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        with:
          sarif_file: "trivy-results-latest.sarif"
          category: "docker-latest"

  docker-scout-scan:
    name: Docker Scout Security Analysis
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_run' && needs.check-cd-status.outputs.should-scan == 'true')
    needs: [check-cd-status]
    continue-on-error: true # Don't fail the whole pipeline if Scout has issues

    permissions:
      security-events: write
      contents: read
      actions: read
      pull-requests: write # For PR comments

    steps:
      - uses: actions/checkout@v6

      - name: Check if latest image exists for Scout scan
        id: scout-image-check
        run: |
          if docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Image latest exists for Scout scan"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Image latest does not exist, skipping Scout scan"
          fi

      # Set up Docker Buildx (required for Scout)
      - name: Set up Docker Buildx
        if: steps.scout-image-check.outputs.exists == 'true'
        uses: docker/setup-buildx-action@v3

      # Login to GitHub Container Registry (required for Docker Scout)
      - name: Log in to Container Registry
        if: steps.scout-image-check.outputs.exists == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker Scout CVE Analysis
        if: steps.scout-image-check.outputs.exists == 'true'
        uses: docker/scout-action@v1
        with:
          command: cves
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          sarif-file: docker-scout-cves.sarif
          summary: true
        continue-on-error: true # Continue even if Scout fails due to entitlement issues

      - name: Docker Scout Policy Evaluation
        if: steps.scout-image-check.outputs.exists == 'true'
        uses: docker/scout-action@v1
        with:
          command: policy
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          exit-code: false # Don't fail on policy violations, just report
        continue-on-error: true # Continue even if Scout fails due to entitlement issues

      - name: Docker Scout SBOM Generation
        if: steps.scout-image-check.outputs.exists == 'true'
        uses: docker/scout-action@v1
        with:
          command: sbom
          image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          format: json
          output: docker-scout-sbom.json
        continue-on-error: true # Continue even if Scout fails due to entitlement issues

      - name: Upload Scout CVE results to GitHub Security tab
        if: steps.scout-image-check.outputs.exists == 'true' && hashFiles('docker-scout-cves.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        continue-on-error: true
        with:
          sarif_file: docker-scout-cves.sarif
          category: "docker-scout"

      - name: Upload Scout artifacts
        if: steps.scout-image-check.outputs.exists == 'true' && always()
        uses: actions/upload-artifact@v6
        with:
          name: docker-scout-results
          path: |
            docker-scout-*.sarif
            docker-scout-*.json
          retention-days: 30
        continue-on-error: true

  # Fallback security scanning with Trivy (no entitlements required)
  trivy-scan:
    name: Trivy Security Analysis (Fallback)
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'schedule') ||
      (github.event_name == 'workflow_run' && needs.check-cd-status.outputs.should-scan == 'true')
    needs: [check-cd-status]
    continue-on-error: true

    permissions:
      security-events: write
      contents: read
      actions: read

    steps:
      - uses: actions/checkout@v6

      - name: Check if latest image exists for Trivy scan
        id: trivy-image-check
        run: |
          if docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest > /dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Image latest exists for Trivy scan"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Image latest does not exist, skipping Trivy scan"
          fi

      - name: Login to GitHub Container Registry
        if: steps.trivy-image-check.outputs.exists == 'true'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Trivy vulnerability scanner
        if: steps.trivy-image-check.outputs.exists == 'true'
        uses: aquasecurity/trivy-action@0.34.0
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          format: "sarif"
          output: "trivy-results.sarif"

      - name: Upload Trivy scan results to GitHub Security tab
        if: steps.trivy-image-check.outputs.exists == 'true'
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: "trivy-results.sarif"
          category: "trivy"

      - name: Upload Trivy results
        if: steps.trivy-image-check.outputs.exists == 'true' && always()
        uses: actions/upload-artifact@v6
        with:
          name: trivy-results
          path: trivy-results.sarif
          retention-days: 30

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs:
      [
        check-cd-status,
        python-security-scan,
        docker-security-scan-dev,
        docker-security-scan-latest,
        docker-scout-scan,
      ]
    if: always() && (needs.python-security-scan.result != 'skipped' || needs.docker-security-scan-dev.result != 'skipped' || needs.docker-security-scan-latest.result != 'skipped')
    permissions:
      contents: write # Required for creating commit comments
      actions: read # Required for downloading artifacts

    steps:
      - name: Create security summary
        run: |
          echo "# üîí Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Python security status
          if [ "${{ needs.python-security-scan.result }}" == "success" ]; then
            echo "‚úÖ **Python Security Scan:** Passed (bandit + pip-audit + CodeQL)" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Python Security Scan:** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          # Docker security status
          dev_result="${{ needs.docker-security-scan-dev.result }}"
          latest_result="${{ needs.docker-security-scan-latest.result }}"
          scout_result="${{ needs.docker-scout-scan.result }}"

          if [ "$dev_result" == "success" ] || [ "$latest_result" == "success" ]; then
            echo "‚úÖ **Docker Security Scan (Trivy):** Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Docker Security Scan (Trivy):** Failed" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "$scout_result" == "success" ]; then
            echo "‚úÖ **Docker Security Scan (Scout):** Passed" >> $GITHUB_STEP_SUMMARY
          elif [ "$scout_result" == "failure" ]; then
            echo "‚ùå **Docker Security Scan (Scout):** Failed" >> $GITHUB_STEP_SUMMARY
          elif [ "$scout_result" == "skipped" ]; then
            echo "‚è≠Ô∏è **Docker Security Scan (Scout):** Skipped" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è **Docker Security Scan (Scout):** $scout_result" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìä **Detailed reports available in GitHub Security tab**" >> $GITHUB_STEP_SUMMARY

      - name: Comment on commit (if triggered by CD)
        if: github.event_name == 'workflow_run' && needs.check-cd-status.outputs.should-scan == 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pythonStatus = '${{ needs.python-security-scan.result }}' === 'success' ? '‚úÖ' : '‚ùå';
            const devStatus = '${{ needs.docker-security-scan-dev.result }}';
            const latestStatus = '${{ needs.docker-security-scan-latest.result }}';
            const dockerStatus = (devStatus === 'success' || latestStatus === 'success') ? '‚úÖ' : '‚ùå';

            const body = `üîí **Security Scan Completed**

            ${pythonStatus} Python Code Security
            ${dockerStatus} Docker Image Security

            üìä [View detailed results](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`;

            await github.rest.repos.createCommitComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              commit_sha: '${{ github.event.workflow_run.head_sha || github.sha }}',
              body: body
            });
